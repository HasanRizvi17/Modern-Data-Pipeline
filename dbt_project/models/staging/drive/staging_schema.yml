version: 2

models:

  ### CITY
  - name: drive_city_stg
    columns:
      - name: city_id
        tests:
          - not_null
          - unique

      - name: city_name
        tests:
          - not_null

      - name: country_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_country_stg')
              field: country_id

      - name: timezone
        tests:
          - not_null

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### COUNTRY
  - name: drive_country_stg
    columns:
      - name: country_id
        tests:
          - not_null
          - unique

      - name: country_name
        tests:
          - not_null

      - name: iso_code
        tests:
          - not_null
          - accepted_values:
              values: ['DE','FR','IT','ES','NL','GB','US','CA']

      - name: currency
        tests:
          - not_null
          - accepted_values:
              values: ['EUR','USD','CAD','GBP']

      - name: market_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_market_stg')
              field: market_id

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### MARKET
  - name: drive_market_stg
    columns:
      - name: market_id
        tests:
          - not_null
          - unique

      - name: market_name
        tests:
          - not_null

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### USER
  - name: drive_user_stg
    columns:
      - name: user_id
        tests:
          - not_null
          - unique

      - name: email
        tests:
          - not_null

      - name: status
        tests:
          - not_null
          - accepted_values:
              values: ['registered','validated','active','banned','deleted']

      - name: city_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_city_stg')
              field: city_id

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null

  
  ### VEHICLE MODEL
  - name: drive_vehicle_model_stg
    columns:
      - name: model_id
        tests:
          - not_null
          - unique

      - name: brand
        tests:
          - not_null

      - name: model_name
        tests:
          - not_null

      - name: energy_type
        tests:
          - not_null
          - accepted_values:
              values: ['electric', 'fuel']

      - name: segment
        tests:
          - not_null
          - accepted_values:
              values: ['economy', 'comfort', 'premium']

      - name: seats
        tests:
          - not_null

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### VEHICLE FLEET
  - name: drive_vehicle_fleet_stg
    columns:
      - name: fleet_id
        tests:
          - not_null
          - unique

      - name: fleet_name
        tests:
          - not_null

      - name: company_type
        tests:
          - not_null
          - accepted_values:
              values: ['owned', 'leased', 'partner']

      - name: city_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_city_stg')
              field: city_id

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### VEHICLE
  - name: drive_vehicle_stg
    columns:
      - name: vehicle_id
        tests:
          - not_null
          - unique

      - name: city_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_city_stg')
              field: city_id

      - name: model_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_vehicle_model_stg')
              field: model_id

      - name: fleet_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_vehicle_fleet_stg')
              field: fleet_id

      - name: status
        tests:
          - not_null
          - accepted_values:
              values: ['active', 'maintenance', 'decommissioned']

      - name: battery_level

      - name: fuel_level

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### TRIP PACKAGE
  - name: drive_trip_package_stg
    columns:
      - name: package_id
        tests:
          - not_null
          - unique

      - name: package_name
        tests:
          - not_null
          - accepted_values:
              values: ['per-minute', 'per-hour', 'daily', 'unlimited']

      - name: active_from
        tests:
          - not_null

      - name: active_to

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### PROMOTION
  - name: drive_promotion_stg
    columns:
      - name: promo_id
        tests:
          - not_null
          - unique

      - name: promo_code
        tests:
          - not_null

      - name: discount_amount
        tests:
          - not_null

      - name: discount_type
        tests:
          - not_null
          - accepted_values:
              values: ['percentage', 'fixed']

      - name: start_date
        tests:
          - not_null

      - name: end_date

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### USER PROMOTION
  - name: drive_user_promotion_stg
    columns:
      - name: user_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_user_stg')
              field: user_id

      - name: promo_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_promotion_stg')
              field: promo_id

      - name: redeemed_at

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### RESERVATION
  - name: drive_reservation_stg
    columns:
      - name: reservation_id
        tests:
          - not_null
          - unique

      - name: user_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_user_stg')
              field: user_id

      - name: vehicle_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_vehicle_stg')
              field: vehicle_id

      - name: city_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_city_stg')
              field: city_id

      - name: package_id
        tests:
          - relationships:
              to: ref('drive_trip_package_stg')
              field: package_id

      - name: reserved_at
        tests:
          - not_null

      - name: reservation_start_at
        tests:
          - not_null

      - name: reservation_end_at

      - name: status
        tests:
          - not_null
          - accepted_values:
              values: ['pending', 'confirmed', 'cancelled', 'expired', 'converted_to_rental']

      - name: cancellation_reason

      - name: cancelled_at

      - name: rental_id
        tests:
          - relationships:
              to: ref('drive_rental_stg')
              field: rental_id

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### RENTAL
  - name: drive_rental_stg
    columns:
      - name: rental_id
        tests:
          - not_null
          - unique

      - name: user_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_user_stg')
              field: user_id

      - name: vehicle_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_vehicle_stg')
              field: vehicle_id

      - name: package_id
        tests:
          - relationships:
              to: ref('drive_trip_package_stg')
              field: package_id

      - name: start_city_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_city_stg')
              field: city_id

      - name: end_city_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_city_stg')
              field: city_id

      - name: start_time
        tests:
          - not_null

      - name: end_time

      - name: status
        tests:
          - not_null
          - accepted_values:
              values:
                - completed
                - cancelled
                - ongoing

      - name: distance_km

      - name: final_cost

      - name: promo_id
        tests:
          - relationships:
              to: ref('drive_promotion_stg')
              field: promo_id

      - name: reservation_id
        tests:
          - relationships:
              to: ref('drive_reservation_stg')
              field: reservation_id

      - name: incident_id
        tests:
          - relationships:
              to: ref('drive_incident_stg')
              field: incident_id

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### RENTAL RATING
  - name: drive_rental_rating_stg
    columns:
      - name: rating_id
        tests:
          - not_null
          - unique

      - name: rental_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_rental_stg')
              field: rental_id

      - name: score
        tests:
          - not_null

      - name: comment

      - name: created_at
        tests:
          - not_null

      - name: ingestion_timestamp
        tests:
          - not_null


  ### PAYMENT
  - name: drive_payment_stg
    columns:
      - name: payment_id
        tests:
          - not_null
          - unique

      - name: rental_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_rental_stg')
              field: rental_id

      - name: user_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_user_stg')
              field: user_id

      - name: amount
        tests:
          - not_null

      - name: status
        tests:
          - not_null
          - accepted_values:
              values: ['succeeded','failed','refunded']

      - name: method
        tests:
          - not_null
          - accepted_values:
              values: ['card','wallet']

      - name: currency
        tests:
          - not_null
          - accepted_values:
              values: ['EUR','USD','CAD','GBP']

      - name: created_at
        tests:
          - not_null

      - name: ingestion_timestamp
        tests:
          - not_null


  ### REFUND
  - name: drive_refund_stg
    columns:
      - name: refund_id
        tests:
          - not_null
          - unique

      - name: payment_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_payment_stg')
              field: payment_id

      - name: amount
        tests:
          - not_null

      - name: reason
        tests:
          - not_null

      - name: created_at
        tests:
          - not_null

      - name: ingestion_timestamp
        tests:
          - not_null


  ### INCIDENT
  - name: drive_incident_stg
    columns:
      - name: incident_id
        tests:
          - not_null
          - unique

      - name: rental_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_rental_stg')
              field: rental_id

      - name: user_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_user_stg')
              field: user_id

      - name: vehicle_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_vehicle_stg')
              field: vehicle_id

      - name: city_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_city_stg')
              field: city_id

      - name: type
        tests:
          - not_null
          - accepted_values:
              values: ['accident','damage','theft','breakdown','other']

      - name: severity
        tests:
          - not_null
          - accepted_values:
              values: ['minor','moderate','severe','critical']

      - name: status
        tests:
          - not_null
          - accepted_values:
              values: ['reported','under_review','resolved','closed','insurance_claimed']

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null


  ### SUPPORT TICKET
  - name: drive_support_ticket_stg
    columns:
      - name: ticket_id
        tests:
          - not_null
          - unique

      - name: user_id
        tests:
          - relationships:
              to: ref('drive_user_stg')
              field: user_id

      - name: rental_id
        tests:
          - relationships:
              to: ref('drive_rental_stg')
              field: rental_id

      - name: incident_id
        tests:
          - relationships:
              to: ref('drive_incident_stg')
              field: incident_id

      - name: vehicle_id
        tests:
          - relationships:
              to: ref('drive_vehicle_stg')
              field: vehicle_id

      - name: category
        tests:
          - not_null
          - accepted_values:
              values: ['billing', 'vehicle_issue', 'account', 'booking', 'incident', 'app_bug', 'other']

      - name: priority
        tests:
          - not_null
          - accepted_values:
              values: ['low','medium','high','critical']

      - name: status
        tests:
          - not_null
          - accepted_values:
              values: ['open','in_progress','resolved','closed']

      - name: channel
        tests:
          - not_null
          - accepted_values:
              values: ['app','email','phone','chat']

      - name: created_at
        tests:
          - not_null

      - name: updated_at

      - name: satisfaction_rating

      - name: ingestion_timestamp
        tests:
          - not_null


  ### TICKET HISTORY
  - name: drive_ticket_history_stg
    columns:
      - name: history_id
        tests:
          - not_null
          - unique

      - name: ticket_id
        tests:
          - not_null
          - relationships:
              to: ref('drive_support_ticket_stg')
              field: ticket_id

      - name: changed_at
        tests:
          - not_null

      - name: changed_by
        tests:
          - not_null
          - accepted_values:
              values: ['user','agent','system']

      - name: field_changed
        tests:
          - not_null

      - name: old_value

      - name: new_value
        tests:
          - not_null

      # - name: created_at

      # - name: updated_at

      - name: ingestion_timestamp
        tests:
          - not_null
